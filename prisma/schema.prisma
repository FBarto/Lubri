generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id           Int           @id @default(autoincrement())
  name         String
  phone        String        @unique
  legacyId     String?       @unique
  createdAt    DateTime      @default(now())
  appointments Appointment[]
  leadCases    LeadCase[]
  pendingSales PendingSale[]
  sales        Sale[]
  vehicles     Vehicle[]
  workOrders   WorkOrder[]
}

model Vehicle {
  id                   Int           @id @default(autoincrement())
  plate                String        @unique
  brand                String?
  model                String?
  type                 String?
  year                 Int?
  notes                String?
  mileage              Int?
  clientId             Int
  specifications       Json?
  averageDailyKm       Float?        @default(0)
  lastServiceDate      DateTime?
  lastServiceMileage   Int?
  predictedNextService DateTime?
  appointments         Appointment[]
  leadCases            LeadCase[]
  pendingSales         PendingSale[]
  client               Client        @relation(fields: [clientId], references: [id])
  workOrders           WorkOrder[]
}

model Service {
  id           Int           @id @default(autoincrement())
  name         String
  category     String
  duration     Int
  price        Float
  active       Boolean       @default(true)
  appointments Appointment[]
  workOrders   WorkOrder[]
}

model Appointment {
  id               Int               @id @default(autoincrement())
  date             DateTime
  status           AppointmentStatus @default(REQUESTED)
  calendarEventId  String?
  reminderAt       DateTime?
  reminderSentAt   DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  notes            String?
  clientId         Int
  vehicleId        Int
  serviceId        Int
  leadCaseId       String?           @unique
  client           Client            @relation(fields: [clientId], references: [id])
  leadCase         LeadCase?         @relation(fields: [leadCaseId], references: [id])
  service          Service           @relation(fields: [serviceId], references: [id])
  vehicle          Vehicle           @relation(fields: [vehicleId], references: [id])
  whatsappMessages WhatsAppMessage[]
  whatsappTokens   WhatsAppToken[]
  workOrder        WorkOrder?
}

model WorkOrder {
  id             Int                   @id @default(autoincrement())
  status         WorkOrderStatus       @default(PENDING)
  date           DateTime              @default(now())
  finishedAt     DateTime?
  mileage        Int?
  price          Float
  notes          String?
  appointmentId  Int?                  @unique
  clientId       Int
  vehicleId      Int
  serviceId      Int
  saleId         Int?
  userId         Int?
  approvalStatus String                @default("IDLE")
  approvalToken  String?               @unique
  approvalSentAt DateTime?
  serviceDetails Json?
  pendingSale    PendingSale[]
  saleItems      SaleItem[]
  appointment    Appointment?          @relation(fields: [appointmentId], references: [id])
  client         Client                @relation(fields: [clientId], references: [id])
  sale           Sale?                 @relation(fields: [saleId], references: [id])
  service        Service               @relation(fields: [serviceId], references: [id])
  user           User?                 @relation(fields: [userId], references: [id])
  vehicle        Vehicle               @relation(fields: [vehicleId], references: [id])
  attachments    WorkOrderAttachment[]
}

model WhatsAppMessage {
  id            Int         @id @default(autoincrement())
  phone         String
  template      String
  variables     String?
  status        String      @default("PENDING")
  scheduledAt   DateTime
  sentAt        DateTime?
  error         String?
  appointmentId Int
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
}

model WhatsAppToken {
  id            Int         @id @default(autoincrement())
  token         String      @unique
  action        String
  expiresAt     DateTime
  usedAt        DateTime?
  appointmentId Int
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
}

model Product {
  id           Int               @id @default(autoincrement())
  name         String
  code         String?           @unique
  barcode      String?
  category     String
  price        Float
  stock        Float             @default(0)
  minStock     Float             @default(0)
  active       Boolean           @default(true)
  cost         Float             @default(0)
  markup       Float             @default(0)
  supplier     String?
  pendingItems PendingSaleItem[]
  saleItems    SaleItem[]
}

model Sale {
  id            Int          @id @default(autoincrement())
  date          DateTime     @default(now())
  total         Float
  paymentMethod String?
  clientId      Int?
  userId        Int?
  status        String       @default("COMPLETED")
  pendingSale   PendingSale?
  client        Client?      @relation(fields: [clientId], references: [id])
  user          User?        @relation(fields: [userId], references: [id])
  items         SaleItem[]
  workOrders    WorkOrder[]
}

model SaleItem {
  id          Int        @id @default(autoincrement())
  saleId      Int
  type        String
  description String
  quantity    Float
  unitPrice   Float
  subtotal    Float
  productId   Int?
  workOrderId Int?
  product     Product?   @relation(fields: [productId], references: [id])
  sale        Sale       @relation(fields: [saleId], references: [id])
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])
}

model User {
  id            Int            @id @default(autoincrement())
  name          String?
  username      String         @unique
  passwordHash  String
  role          String         @default("EMPLOYEE")
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  auditLogs     AuditLog[]
  createdLogs   CaseLog[]
  assignedCases LeadCase[]
  notifications Notification[]
  pendingSales  PendingSale[]
  sales         Sale[]
  workOrders    WorkOrder[]
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  entity    String
  entityId  String?
  details   String?
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model PaymentPlan {
  id           Int     @id @default(autoincrement())
  name         String
  installments Int
  interestRate Float
  active       Boolean @default(true)
}

model WorkOrderAttachment {
  id          Int       @id @default(autoincrement())
  url         String
  type        String
  description String?
  workOrderId Int
  createdAt   DateTime  @default(now())
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
}

model LeadCase {
  id               String              @id @default(cuid())
  type             CaseType
  status           CaseStatus          @default(NEW)
  priority         Priority            @default(MEDIUM)
  serviceCategory  ServiceCategory
  summary          String
  notes            String?
  slaDueAt         DateTime
  lastContactAt    DateTime?
  assignedToUserId Int?
  clientId         Int?
  vehicleId        Int?
  intakeRawText    String?
  intakeParsedJson Json?
  closeReason      String?
  closeDetail      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  appointment      Appointment?
  checklist        CaseChecklistItem[]
  logs             CaseLog[]
  assignedToUser   User?               @relation(fields: [assignedToUserId], references: [id])
  client           Client?             @relation(fields: [clientId], references: [id])
  vehicle          Vehicle?            @relation(fields: [vehicleId], references: [id])
  quote            Quote?
}

model CaseLog {
  id           String     @id @default(cuid())
  leadCaseId   String
  authorUserId Int
  channel      LogChannel
  message      String
  createdAt    DateTime   @default(now())
  authorUser   User       @relation(fields: [authorUserId], references: [id])
  leadCase     LeadCase   @relation(fields: [leadCaseId], references: [id])
}

model Quote {
  id           String      @id @default(cuid())
  leadCaseId   String      @unique
  subtotal     Float       @default(0)
  discount     Float?      @default(0)
  total        Float       @default(0)
  paymentTerms String?
  validUntil   DateTime?
  status       QuoteStatus @default(DRAFT)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  leadCase     LeadCase    @relation(fields: [leadCaseId], references: [id])
  items        QuoteItem[]
}

model QuoteItem {
  id          String @id @default(cuid())
  quoteId     String
  description String
  quantity    Float
  unitPrice   Float
  lineTotal   Float
  kind        String @default("PRODUCT")
  quote       Quote  @relation(fields: [quoteId], references: [id])
}

model CaseChecklistItem {
  id          String            @id @default(cuid())
  leadCaseId  String
  templateKey ChecklistTemplate
  key         String
  label       String
  value       String?
  inputType   InputType
  options     Json?
  isRequired  Boolean           @default(false)
  isDone      Boolean           @default(false)
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  leadCase    LeadCase          @relation(fields: [leadCaseId], references: [id])
}

model Notification {
  id         String   @id @default(cuid())
  userId     Int
  leadCaseId String?
  type       String
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}

model PendingSale {
  id          Int                @id @default(autoincrement())
  status      PendingSaleStatus  @default(DRAFT)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  createdById Int
  channel     PendingSaleChannel @default(POS)
  workOrderId Int?
  clientId    Int?
  vehicleId   Int?
  notes       String?
  currency    String             @default("ARS")
  saleId      Int?               @unique
  version     Int                @default(1)
  client      Client?            @relation(fields: [clientId], references: [id])
  createdBy   User               @relation(fields: [createdById], references: [id])
  sale        Sale?              @relation(fields: [saleId], references: [id])
  vehicle     Vehicle?           @relation(fields: [vehicleId], references: [id])
  workOrder   WorkOrder?         @relation(fields: [workOrderId], references: [id])
  items       PendingSaleItem[]

  @@index([status])
  @@index([createdById, status])
  @@index([clientId])
}

model PendingSaleItem {
  id             Int         @id @default(autoincrement())
  pendingSaleId  Int
  productId      Int?
  nameSnapshot   String
  skuSnapshot    String?
  unitSnapshot   String?
  quantity       Decimal     @db.Decimal(10, 2)
  unitPrice      Decimal     @db.Decimal(12, 2)
  discount       Decimal?    @db.Decimal(12, 2)
  subtotal       Decimal     @db.Decimal(14, 2)
  isUncataloged  Boolean     @default(false)
  sourceMetadata Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  pendingSale    PendingSale @relation(fields: [pendingSaleId], references: [id], onDelete: Cascade)
  product        Product?    @relation(fields: [productId], references: [id])

  @@index([pendingSaleId])
  @@index([productId])
}

enum AppointmentStatus {
  REQUESTED
  CONFIRMED
  TODAY_QUEUE
  IN_PROGRESS
  DONE
  CANCELLED
  NO_SHOW
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DELIVERED
}

enum CaseType {
  APPOINTMENT
  QUOTE
}

enum CaseStatus {
  NEW
  IN_PROGRESS
  WAITING_CUSTOMER
  READY_TO_SCHEDULE
  SCHEDULED
  QUOTED
  WON
  LOST
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum ServiceCategory {
  TYRES
  BATTERY
  OIL_SERVICE
  OTHER
}

enum ChecklistTemplate {
  TYRES
  BATTERY
  OIL_SERVICE
  GENERIC
}

enum LogChannel {
  INTERNAL_NOTE
  WHATSAPP
  CALL
  IN_PERSON
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum InputType {
  TEXT
  NUMBER
  MONEY
  BOOLEAN
  SELECT
  MULTISELECT
}

enum PendingSaleStatus {
  DRAFT
  CONFIRMING
  CONFIRMED
  CANCELLED
}

enum PendingSaleChannel {
  POS
  EMPLOYEE
  ADMIN
}
